-- Creator Session Info and Native Posts (new one - works correctly)

select
distinct
A.app,
A.date,
apps.redshift_app_name,
A.sessions,
A.session_starters,
A.time_in_msec,
B.native_posts
from
(
SELECT 
app
,cast(TO_CHAR(local_datetime::DATE, 'YYYY-MM-DD') as date) as date
,COUNT(*) AS sessions
,COUNT(DISTINCT event.user_id) AS session_starters,
SUM(float1) AS time_in_msec 
FROM public.event event
WHERE event."kingdom" LIKE 'session' 
AND event."phylum" LIKE 'session_end'
and user_map_tag in
(
select ('ut'||id) as user_map_tag from vicky.users
where access_level like '%api_owner%'
)
and app not like '%-%'
GROUP BY 1,2
ORDER BY 1,2
) as A
full outer join
(
select
app,
date,
count(distinct post_id) as native_posts
from
(
select
distinct
a.build_name as app,
s.id as post_id,
s.name as post_name,
date_trunc('day',dateadd(h,-7,s.created_at)) as date
from vicky.sequences s
join vicky.nodes n
on s.id = n.sequence_id
join vicky.contentitems ci
on n.id = ci.node_id
join vicky.apps a
on s.app_id = a.id
join vicky.users u
on s.created_by = u.id
where ci.remote_source is null
and s.category not like '%repost%'
and u.access_level like '%api_owner%'
)
group by 1,2
order by 1,2
) as B
on left(A.app,12) = left(lower(B.app),12)
and A.date = B.date
join public.launch_date ld
on A.app = ld.app
and A.date>=ld.launch_date
--and A.app='failarmy'
and A.app is not null
INNER JOIN vicky.apps
on A.app=apps.redshift_app_name
order by 1,2,3,4;
